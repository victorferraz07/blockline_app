{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<!-- Fundo gradiente estilo Apple -->
<div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50"></div>

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex items-center justify-between">
        <div>
            <a href="{% url 'kanban_board' %}" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium mb-2 inline-block">
                ‚Üê Voltar ao Kanban
            </a>
            <h1 class="text-3xl font-bold text-gray-900">{{ task.titulo }}</h1>
            <p class="text-gray-600 mt-1">Coluna: <span class="font-medium">{{ task.coluna.nome }}</span></p>
        </div>
        <div class="flex flex-col gap-2 items-end">
            {% if task.finalizado %}
            <span class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-medium">‚úì Finalizado</span>
            <span class="text-sm text-gray-600">{{ task.data_finalizacao|date:'d/m/Y H:i' }}</span>
            {% elif task.em_andamento %}
            <span class="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg font-medium">‚ö° Em Andamento</span>
            {% else %}
            <span class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium">‚è∏ Pendente</span>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Coluna Principal -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Informa√ß√µes do Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Informa√ß√µes</h2>

                {% if task.descricao %}
                <div class="mb-4">
                    <label class="text-sm font-semibold text-gray-700 block mb-1">Descri√ß√£o</label>
                    <p class="text-gray-600">{{ task.descricao }}</p>
                </div>
                {% endif %}

                <div class="space-y-4">
                    <!-- Progresso Visual -->
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-semibold text-gray-700">Progresso de Produ√ß√£o</label>
                            <span class="text-lg font-bold text-indigo-700">{{ task.percentual_completo }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden mb-2">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-4 rounded-full transition-all duration-300 flex items-center justify-end px-2"
                                 style="width: {{ task.percentual_completo }}%">
                                {% if task.percentual_completo > 20 %}
                                <span class="text-white text-xs font-bold">{{ task.percentual_completo }}%</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-emerald-50 rounded-lg p-2">
                                <div class="text-xs text-emerald-600 font-medium mb-1">Produzidas</div>
                                <div class="text-xl font-bold text-emerald-700">{{ task.quantidade_produzida }}</div>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-2">
                                <div class="text-xs text-orange-600 font-medium mb-1">Restantes</div>
                                <div class="text-xl font-bold text-orange-700">{{ task.quantidade_restante }}</div>
                            </div>
                            <div class="bg-indigo-50 rounded-lg p-2">
                                <div class="text-xs text-indigo-600 font-medium mb-1">Meta Total</div>
                                <div class="text-xl font-bold text-indigo-700">{{ task.quantidade_meta }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="pt-2 border-t border-gray-200">
                        <label class="text-sm font-semibold text-gray-700 block mb-1">Criado em</label>
                        <p class="text-gray-600">{{ task.criado_em|date:'d/m/Y H:i' }}</p>
                    </div>
                </div>
            </div>

            <!-- Hist√≥rico Completo -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìú Hist√≥rico de Atividades</h2>

                <div class="space-y-4">
                    {% for item in historico %}
                    <div class="flex gap-3 pb-4 border-b border-gray-100 last:border-0">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white font-bold">
                                {% if item.usuario %}
                                {{ item.usuario.username|slice:":1"|upper }}
                                {% else %}
                                ?
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-gray-900">
                                    {% if item.usuario %}
                                    {{ item.usuario.get_full_name|default:item.usuario.username }}
                                    {% else %}
                                    Sistema
                                    {% endif %}
                                </span>
                                <span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded text-xs font-medium">
                                    {{ item.get_tipo_acao_display }}
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm">{{ item.descricao }}</p>
                            <span class="text-xs text-gray-400 mt-1 block">{{ item.data|date:'d/m/Y H:i' }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-400 italic text-center py-4">Nenhuma atividade registrada ainda.</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Quantidades Registradas -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Quantidades Produzidas</h2>

                <div class="space-y-3">
                    {% for qtd in quantidades %}
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-emerald-500 flex items-center justify-center text-white font-bold">
                                {% if qtd.usuario %}
                                {{ qtd.usuario.username|slice:":1"|upper }}
                                {% else %}
                                ?
                                {% endif %}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">
                                    {% if qtd.usuario %}
                                    {{ qtd.usuario.get_full_name|default:qtd.usuario.username }}
                                    {% else %}
                                    Usu√°rio Desconhecido
                                    {% endif %}
                                </p>
                                <p class="text-xs text-gray-500">{{ qtd.data|date:'d/m/Y H:i' }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-green-600">+{{ qtd.quantidade }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-gray-400 italic text-center py-4">Nenhuma quantidade registrada ainda.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Respons√°veis -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">üë• Respons√°veis</h2>

                <div class="space-y-2">
                    {% for user in task.responsaveis.all %}
                    <div class="flex items-center gap-2 p-2 bg-blue-50 rounded-lg">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-indigo-500 flex items-center justify-center text-white text-xs font-bold">
                            {{ user.username|slice:":1"|upper }}
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ user.get_full_name|default:user.username }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-400 italic text-sm text-center py-2">Nenhum respons√°vel atribu√≠do</p>
                    {% endfor %}
                </div>
            </div>

            <!-- Usu√°rios que Trabalharam -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">üîß Usu√°rios que Trabalharam</h2>

                <div class="space-y-2">
                    {% for user in usuarios_trabalharam %}
                    <div class="flex items-center gap-2 p-2 bg-purple-50 rounded-lg">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-500 flex items-center justify-center text-white text-xs font-bold">
                            {{ user.username|slice:":1"|upper }}
                        </div>
                        <span class="text-sm font-medium text-gray-900">{{ user.get_full_name|default:user.username }}</span>
                    </div>
                    {% empty %}
                    <p class="text-gray-400 italic text-sm text-center py-2">Nenhum usu√°rio trabalhou neste card ainda</p>
                    {% endfor %}
                </div>
            </div>

            <!-- A√ß√µes -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4">‚ö° A√ß√µes R√°pidas</h2>

                <div class="space-y-2">
                    <a href="{% url 'editar_tarefa' task_id=task.id %}" class="block w-full px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium text-center transition-colors">
                        ‚úèÔ∏è Editar Card
                    </a>

                    {% if not task.finalizado %}
                    <form method="post" action="{% url 'marcar_andamento' task_id=task.id %}" class="w-full">
                        {% csrf_token %}
                        <button type="submit" class="w-full px-4 py-2 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium transition-colors">
                            ‚ñ∂Ô∏è Iniciar Card
                        </button>
                    </form>

                    <form method="post" action="{% url 'finalizar' task_id=task.id %}" class="w-full" onsubmit="return confirm('Tem certeza que deseja finalizar este card? Esta a√ß√£o marcar√° o card como conclu√≠do.')">
                        {% csrf_token %}
                        <button type="submit" class="w-full px-4 py-2 rounded-lg bg-green-100 hover:bg-green-200 text-green-700 font-medium transition-colors">
                            ‚úì Finalizar Card
                        </button>
                    </form>
                    {% else %}
                    <form method="post" action="{% url 'desfinalizar' task_id=task.id %}" class="w-full" onsubmit="return confirm('Deseja reabrir este card?')">
                        {% csrf_token %}
                        <button type="submit" class="w-full px-4 py-2 rounded-lg bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-medium transition-colors">
                            ‚Ü©Ô∏è Reabrir Card
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}