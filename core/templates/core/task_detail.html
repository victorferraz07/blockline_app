{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ task.titulo }}{% endblock %}

{% block extra_css %}
<style>
    .timeline-item {
        position: relative;
        padding-left: 2rem;
        padding-bottom: 1.5rem;
        border-left: 2px solid #e5e7eb;
    }

    .timeline-item:last-child {
        border-left-color: transparent;
        padding-bottom: 0;
    }

    .timeline-dot {
        position: absolute;
        left: -0.5rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: white;
        border: 2px solid #6366f1;
    }

    .subtask-card {
        transition: all 0.2s;
    }

    .subtask-card:hover {
        transform: translateX(4px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Breadcrumb -->
    <div class="mb-4 text-sm text-gray-600">
        <a href="{% url 'roadmap_timeline' %}" class="hover:text-indigo-600">Projetos</a>
        <span class="mx-2">‚Üí</span>
        <a href="{% url 'roadmap_timeline' %}?project={{ task.project.id }}" class="hover:text-indigo-600">{{ task.project.nome }}</a>
        <span class="mx-2">‚Üí</span>
        <span class="text-gray-900 font-medium">{{ task.titulo }}</span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Coluna Principal -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Header da Tarefa -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-gray-900 mb-3">{{ task.titulo }}</h1>

                        <!-- Badges -->
                        <div class="flex gap-2 flex-wrap mb-4">
                            <!-- Status -->
                            <span class="px-3 py-1 rounded-full text-sm font-semibold
                                {% if task.status == 'todo' %}bg-gray-200 text-gray-800
                                {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                                {% elif task.status == 'review' %}bg-yellow-100 text-yellow-800
                                {% elif task.status == 'done' %}bg-green-100 text-green-800
                                {% elif task.status == 'blocked' %}bg-red-100 text-red-800{% endif %}">
                                {{ task.get_status_display }}
                            </span>

                            <!-- Priority -->
                            <span class="px-3 py-1 rounded-full text-sm font-semibold
                                {% if task.priority == 'low' %}bg-green-100 text-green-800
                                {% elif task.priority == 'medium' %}bg-blue-100 text-blue-800
                                {% elif task.priority == 'high' %}bg-orange-100 text-orange-800
                                {% elif task.priority == 'critical' %}bg-red-100 text-red-800{% endif %}">
                                {{ task.get_priority_display }}
                            </span>

                            <!-- Labels -->
                            {% for label in task.labels.all %}
                                <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background-color: {{ label.cor }}22; color: {{ label.cor }}; border: 1px solid {{ label.cor }}44;">
                                    üè∑Ô∏è {{ label.nome }}
                                </span>
                            {% endfor %}

                            {% if task.esta_atrasado %}
                                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-red-100 text-red-800">
                                    ‚è∞ ATRASADO
                                </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        {% if task.status != 'done' %}
                            <button onclick="concluirTarefa()"
                                    class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center gap-2 font-semibold">
                                ‚úÖ Marcar como Conclu√≠da
                            </button>
                        {% else %}
                            <button onclick="reabrirTarefa()"
                                    class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 transition-colors flex items-center gap-2 font-semibold">
                                üîÑ Reabrir Tarefa
                            </button>
                        {% endif %}
                        <a href="{% url 'editar_task' task.id %}" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            ‚úèÔ∏è Editar
                        </a>
                    </div>
                </div>

                <!-- Descri√ß√£o -->
                {% if task.descricao %}
                    <div class="prose max-w-none">
                        <p class="text-gray-700 whitespace-pre-wrap">{{ task.descricao }}</p>
                    </div>
                {% else %}
                    <p class="text-gray-500 italic">Sem descri√ß√£o</p>
                {% endif %}
            </div>

            <!-- Progresso de Quantidade -->
            {% if task.quantidade_meta > 0 %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìä Progresso de Produ√ß√£o</h2>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm text-gray-600">Produzido</p>
                            <p class="text-3xl font-bold text-indigo-600">{{ task.quantidade_produzida }}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">Meta</p>
                            <p class="text-3xl font-bold text-gray-900">{{ task.quantidade_meta }}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-600">Faltam</p>
                            <p class="text-3xl font-bold text-orange-600">{{ task.quantidade_meta|add:"-"|add:task.quantidade_produzida }}</p>
                        </div>
                    </div>

                    <!-- Barra de Progresso -->
                    <div>
                        <div class="flex justify-between text-sm text-gray-600 mb-2">
                            <span>Percentual Completo</span>
                            <span class="font-bold text-indigo-600">{{ task.percentual_completo }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                            <div class="bg-indigo-600 h-4 rounded-full transition-all flex items-center justify-end pr-2" style="width: {{ task.percentual_completo }}%">
                                {% if task.percentual_completo > 15 %}
                                    <span class="text-xs text-white font-semibold">{{ task.percentual_completo }}%</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Bot√£o de Registrar -->
                    <a href="{% url 'registrar_quantidade_project' task.id %}" class="block w-full text-center px-4 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors font-medium">
                        ‚ûï Registrar Quantidade Produzida
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Subtarefas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">üìù Subtarefas ({{ subtasks.count }})</h2>
                    <a href="{% url 'criar_subtask' task.id %}" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors text-sm font-medium">
                        ‚ûï Nova Subtarefa
                    </a>
                </div>

                {% if subtasks %}
                    <div class="space-y-2">
                        {% for subtask in subtasks %}
                            <div class="subtask-card bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <h3 class="font-semibold text-gray-900 mb-1">{{ subtask.titulo }}</h3>
                                        {% if subtask.descricao %}
                                            <p class="text-sm text-gray-600 mb-2">{{ subtask.descricao|truncatewords:20 }}</p>
                                        {% endif %}
                                        <div class="flex gap-2 items-center">
                                            <span class="px-2 py-1 rounded text-xs font-semibold
                                                {% if subtask.status == 'todo' %}bg-gray-200 text-gray-800
                                                {% elif subtask.status == 'in_progress' %}bg-blue-100 text-blue-800
                                                {% elif subtask.status == 'done' %}bg-green-100 text-green-800{% endif %}">
                                                {{ subtask.get_status_display }}
                                            </span>
                                            {% if subtask.priority == 'high' or subtask.priority == 'critical' %}
                                                <span class="text-xs">üî•</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <a href="{% url 'task_detail' subtask.id %}" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium ml-4">
                                        Ver ‚Üí
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-center py-8">Nenhuma subtarefa criada ainda</p>
                {% endif %}
            </div>

            <!-- Hist√≥rico de Quantidades -->
            {% if quantidades %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìà Hist√≥rico de Produ√ß√£o</h2>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usu√°rio</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observa√ß√µes</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for qtd in quantidades %}
                                <tr>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                        {{ qtd.data|date:"d/m/Y H:i" }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                        {{ qtd.usuario.get_full_name|default:qtd.usuario.username }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-indigo-600">
                                        {{ qtd.quantidade }}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">
                                        {{ qtd.observacoes|truncatewords:15|default:"‚Äî" }}
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                        <a href="{% url 'editar_quantidade_project' qtd.id %}" class="text-indigo-600 hover:text-indigo-900 mr-3">Editar</a>
                                        <form method="post" action="{% url 'excluir_quantidade_project' qtd.id %}" class="inline" onsubmit="return confirm('Excluir este registro?')">
                                            {% csrf_token %}
                                            <button type="submit" class="text-red-600 hover:text-red-900">Excluir</button>
                                        </form>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Hist√≥rico de A√ß√µes -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">üìú Hist√≥rico de A√ß√µes</h2>

                {% if historico %}
                    <div class="space-y-0">
                        {% for item in historico %}
                            <div class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-900">{{ item.descricao }}</p>
                                        <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                            <span>{{ item.usuario.get_full_name|default:item.usuario.username }}</span>
                                            <span>‚Ä¢</span>
                                            <span>{{ item.data|date:"d/m/Y H:i" }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-gray-500 text-center py-8">Nenhuma a√ß√£o registrada</p>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Informa√ß√µes -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="font-bold text-gray-900 mb-4">‚ÑπÔ∏è Informa√ß√µes</h3>

                <div class="space-y-3">
                    <!-- Projeto -->
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Projeto</p>
                        <p class="text-sm font-medium text-gray-900">{{ task.project.nome }}</p>
                    </div>

                    <!-- Milestone -->
                    {% if task.milestone %}
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Milestone</p>
                        <p class="text-sm font-medium text-gray-900">üéØ {{ task.milestone.nome }}</p>
                    </div>
                    {% endif %}

                    <!-- Sprint -->
                    {% if task.sprint %}
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Sprint</p>
                        <p class="text-sm font-medium text-gray-900">üèÉ {{ task.sprint.nome }}</p>
                    </div>
                    {% endif %}

                    <!-- Datas -->
                    {% if task.data_inicio %}
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Data de In√≠cio</p>
                        <p class="text-sm font-medium text-gray-900">üìÖ {{ task.data_inicio|date:"d/m/Y" }}</p>
                    </div>
                    {% endif %}

                    {% if task.data_fim %}
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Data de T√©rmino</p>
                        <p class="text-sm font-medium text-gray-900 {% if task.esta_atrasado %}text-red-600{% endif %}">
                            üèÅ {{ task.data_fim|date:"d/m/Y" }}
                        </p>
                        {% if task.dias_restantes != None %}
                            <p class="text-xs {% if task.esta_atrasado %}text-red-600{% else %}text-gray-500{% endif %} mt-1">
                                {% if task.esta_atrasado %}
                                    Atrasado h√° {{ task.dias_restantes|make_list|first|add:"-" }} dias
                                {% elif task.dias_restantes == 0 %}
                                    Vence hoje
                                {% elif task.dias_restantes == 1 %}
                                    Vence amanh√£
                                {% else %}
                                    Faltam {{ task.dias_restantes }} dias
                                {% endif %}
                            </p>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Estimativa -->
                    {% if task.estimativa %}
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Estimativa</p>
                        <p class="text-sm font-medium text-gray-900">‚è±Ô∏è {{ task.estimativa }} h</p>
                    </div>
                    {% endif %}

                    <!-- Criado -->
                    <div>
                        <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Criado</p>
                        <p class="text-sm text-gray-700">{{ task.criado_em|date:"d/m/Y H:i" }}</p>
                        {% if task.criado_por %}
                            <p class="text-xs text-gray-500">por {{ task.criado_por.get_full_name|default:task.criado_por.username }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Respons√°veis -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="font-bold text-gray-900 mb-4">üë• Respons√°veis</h3>

                {% if task.responsaveis.all %}
                    <div class="space-y-2">
                        {% for resp in task.responsaveis.all %}
                            <div class="flex items-center gap-3 p-2 bg-gray-50 rounded">
                                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-white font-semibold text-sm">
                                    {{ resp.get_full_name.0|default:resp.username.0|upper }}
                                </div>
                                <span class="text-sm font-medium text-gray-900">
                                    {{ resp.get_full_name|default:resp.username }}
                                </span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500">Nenhum respons√°vel atribu√≠do</p>
                {% endif %}
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="font-bold text-gray-900 mb-4">‚ö° A√ß√µes R√°pidas</h3>

                <div class="space-y-2">
                    {% if task.quantidade_meta > 0 %}
                        <a href="{% url 'registrar_quantidade_project' task.id %}" class="block w-full text-center px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 transition-colors text-sm font-medium">
                            ‚ûï Registrar Produ√ß√£o
                        </a>
                    {% endif %}

                    <a href="{% url 'criar_subtask' task.id %}" class="block w-full text-center px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition-colors text-sm font-medium">
                        üìù Criar Subtarefa
                    </a>

                    <a href="{% url 'editar_task' task.id %}" class="block w-full text-center px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 transition-colors text-sm font-medium">
                        ‚úèÔ∏è Editar Tarefa
                    </a>

                    <a href="{% url 'roadmap_timeline' %}?project={{ task.project.id }}" class="block w-full text-center px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors text-sm font-medium">
                        üîô Voltar ao Projeto
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCsrfToken() {
    return document.cookie.split('; ').find(r => r.startsWith('csrftoken='))?.split('=')[1];
}

async function alterarStatus(novoStatus) {
    try {
        const response = await fetch('{% url "alterar_status" task.id %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `status=${novoStatus}`
        });

        const data = await response.json();

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Erro: ' + (data.message || 'N√£o foi poss√≠vel alterar o status'));
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao alterar status da tarefa.');
    }
}

function concluirTarefa() {
    if (confirm('Marcar esta tarefa como conclu√≠da?')) {
        alterarStatus('done');
    }
}

function reabrirTarefa() {
    if (confirm('Reabrir esta tarefa?')) {
        alterarStatus('in_progress');
    }
}
</script>
{% endblock %}
