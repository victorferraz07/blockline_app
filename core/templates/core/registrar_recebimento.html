{% extends 'core/base.html' %}

{% block content %}
<div class="container mx-auto">
    <div class="grid grid-cols-1 {% if not is_editing %}lg:grid-cols-3{% endif %} gap-8">
        
        <div class="{% if not is_editing %}lg:col-span-2{% else %}col-span-1 lg:col-span-3{% endif %}">
            <div class="bg-white p-8 rounded-lg shadow-md {% if is_editing %}max-w-4xl mx-auto{% endif %}">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">{{ titulo }}</h1>

                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="space-y-6">
                        
                        {% if user.is_superuser and form.empresa %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700">{{ form.empresa.label }}</label>
                            {{ form.empresa }}
                        </div>
                        {% endif %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">{{ form.numero_nota_fiscal.label }}</label>
                                {{ form.numero_nota_fiscal }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">{{ form.fornecedor.label }}</label>
                                {{ form.fornecedor }}
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">{{ form.setor.label }}</label>
                                {{ form.setor }}
                            </div>
                            {% if is_editing %}
                            <div>
                                <label class="block text-sm font-medium text-gray-700">{{ form.status.label }}</label>
                                {{ form.status }}
                            </div>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">{{ form.valor_total.label }}</label>
                            {{ form.valor_total }}
                        </div>
                        
                        <hr class="my-4">

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">{{ form.foto_documento.label }}</label>
                                {% if is_editing and recebimento.foto_documento %}
                                    <div class="mb-2"><img src="{{ recebimento.foto_documento.url }}" class="h-40 w-auto rounded-md shadow-sm border"></div>
                                    <label for="{{ form.foto_documento.clear_id }}" class="mt-2 flex items-center text-sm text-red-600 font-semibold hover:text-red-800 cursor-pointer">
                                        {{ form.foto_documento.clear }}<span class="ml-2">Excluir Imagem Atual</span>
                                    </label>
                                    <p class="text-xs text-gray-500 pt-2">Para trocar a imagem, escolha um novo arquivo:</p>
                                {% endif %}
                                {{ form.foto_documento }}
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">{{ form.foto_embalagem.label }}</label>
                                {% if is_editing and recebimento.foto_embalagem %}
                                    <div class="mb-2"><img src="{{ recebimento.foto_embalagem.url }}" class="h-40 w-auto rounded-md shadow-sm border"></div>
                                    <label for="{{ form.foto_embalagem.clear_id }}" class="mt-2 flex items-center text-sm text-red-600 font-semibold hover:text-red-800 cursor-pointer">
                                        {{ form.foto_embalagem.clear }}<span class="ml-2">Excluir Imagem Atual</span>
                                    </label>
                                    <p class="text-xs text-gray-500 pt-2">Para trocar a imagem, escolha um novo arquivo:</p>
                                {% endif %}
                                {{ form.foto_embalagem }}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">{{ form.observacoes.label }}</label>
                            {{ form.observacoes }}
                        </div>
                    </div>
                    
                    <div class="flex justify-end mt-8 border-t pt-6">
                        <a href="{% url 'lista_recebimentos' %}" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 mr-4 font-semibold">Cancelar</a>
                        <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 font-semibold">
                            {% if is_editing %}Salvar Alterações{% else %}Registrar Recebimento{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        {% if not is_editing %}
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Histórico Recente</h2>
                <ul class="space-y-4">
                    {% for recebimento_hist in ultimos_recebimentos %}
                        <li class="border-b border-gray-200 pb-3">
                            <p class="font-semibold text-gray-700 truncate">NF: {{ recebimento_hist.numero_nota_fiscal|default:"S/N" }}</p>
                            <p class="text-sm text-gray-600">De: <strong>{{ recebimento_hist.fornecedor.nome|default:"N/A" }}</strong></p>
                            <p class="text-xs text-gray-400 mt-1">{{ recebimento_hist.data_recebimento|date:"d/m/Y H:i" }} por {{ recebimento_hist.usuario.username|default:"-" }}</p>
                        </li>
                    {% empty %}
                        <li class="text-sm text-gray-500">Nenhum recebimento registrado ainda.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.tom-select-criavel').forEach((element) => {
            new TomSelect(element, { create: true, sortField: { field: "text", direction: "asc" } });
        });
    });
</script>
{% endblock %}