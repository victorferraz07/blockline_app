{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<!-- Fundo gradiente estilo Apple -->
<div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50"></div>

<!-- Header moderno -->
<div class="mb-6" x-data="{ showHistory: false }">
    <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-900">Quadro Kanban</h1>
        <div class="flex gap-2">
            <a href="{% url 'metricas_kanban' %}" class="px-4 py-2 rounded-lg bg-white shadow-sm hover:shadow-md transition-all duration-200 text-sm font-medium text-gray-700 hover:text-gray-900">
                üìà M√©tricas
            </a>
            <button @click="showHistory = !showHistory" class="px-4 py-2 rounded-lg bg-white shadow-sm hover:shadow-md transition-all duration-200 text-sm font-medium text-gray-700 hover:text-gray-900">
                <span x-show="!showHistory">üìä Ver Hist√≥rico</span>
                <span x-show="showHistory">‚úï Fechar Hist√≥rico</span>
            </button>
        </div>
    </div>

    <!-- Hist√≥rico Slide Down -->
    <div x-show="showHistory" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 -translate-y-4" x-transition:enter-end="opacity-100 translate-y-0" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 translate-y-0" x-transition:leave-end="opacity-0 -translate-y-4" class="mt-4 bg-white rounded-xl shadow-lg p-6 backdrop-blur-sm">
        <h2 class="text-lg font-bold mb-4 text-gray-900">üìà Hist√≥rico de Produ√ß√£o</h2>
        <ul class="divide-y divide-gray-100">
            {% for q in historico %}
            <li class="py-3 flex flex-col md:flex-row md:items-center md:gap-4 hover:bg-gray-50 rounded-lg px-2 transition-colors">
                <span class="font-semibold text-gray-900">{{ q.task.titulo }}</span>
                <span class="text-emerald-600 font-medium">+{{ q.quantidade }}</span>
                <span class="text-gray-500 text-sm">por {{ q.usuario.get_full_name|default:q.usuario.username }} ‚Ä¢ {{ q.data|date:'d/m/Y H:i' }}</span>
            </li>
            {% empty %}
            <li class="text-gray-400 italic py-4 text-center">Nenhum registro ainda.</li>
            {% endfor %}
        </ul>
    </div>
</div>

<!-- Board Container com scroll horizontal suave -->
<div class="flex gap-4 overflow-x-auto pb-6 px-1 scrollbar-hide" style="scroll-behavior: smooth;">
    {% for coluna in colunas %}
    <div class="kanban-column flex-shrink-0 w-80" data-column-id="{{ coluna.id }}">
        <!-- Column Header -->
        <div class="bg-white rounded-t-xl border border-gray-200 shadow-sm relative overflow-visible">
            <div class="flex items-center justify-between p-4 overflow-visible">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" style="background: {{ coluna.cor }};"></div>
                    <h2 class="font-semibold text-gray-900">{{ coluna.nome }}</h2>
                    <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{{ coluna.tasks.count }}</span>
                </div>
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open" class="p-1 hover:bg-gray-100 rounded transition-colors">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 16 16">
                            <circle cx="8" cy="3" r="1.5"/>
                            <circle cx="8" cy="8" r="1.5"/>
                            <circle cx="8" cy="13" r="1.5"/>
                        </svg>
                    </button>

                    <!-- Dropdown inline mas com z-index alto -->
                    <div x-show="open"
                         @click.away="open = false"
                         x-transition
                         class="absolute right-0 top-full mt-2 w-56 bg-white rounded-xl shadow-2xl border-2 border-gray-800 py-2 overflow-visible"
                         style="z-index: 999999;">
                        <a href="{% url 'editar_coluna' coluna_id=coluna.id %}"
                           class="flex items-center gap-3 px-4 py-3 text-base font-semibold text-gray-900 hover:bg-blue-50 transition-colors border-b border-gray-200">
                            <span class="text-xl">‚úèÔ∏è</span>
                            <span>Editar coluna</span>
                        </a>
                        <form method="post" action="{% url 'excluir_coluna' coluna_id=coluna.id %}" onsubmit="return confirm('Deseja excluir esta coluna?')">
                            {% csrf_token %}
                            <button type="submit"
                                    class="flex items-center gap-3 w-full text-left px-4 py-3 text-base font-semibold text-red-600 hover:bg-red-50 transition-colors">
                                <span class="text-xl">üóëÔ∏è</span>
                                <span>Excluir coluna</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards Container -->
        <div class="backdrop-blur-sm rounded-b-xl border-x border-b border-gray-200 shadow-sm p-3 min-h-[200px] space-y-3"
             style="background: linear-gradient(to bottom, {{ coluna.cor }}50, {{ coluna.cor }}10);">
            {% for task in coluna.tasks.all %}
                <div class="kanban-card group bg-white rounded-lg shadow-sm hover:shadow-md border border-gray-200 p-4 cursor-grab active:cursor-grabbing transition-all duration-200 hover:-translate-y-0.5 {% if task.finalizado %}ring-2 ring-green-400 bg-green-50{% endif %}"
                     data-task-id="{{ task.id }}">

                    <!-- Card Header -->
                    <div class="flex items-start justify-between gap-2 mb-2">
                        <h3 class="font-medium text-gray-900 flex-1 leading-snug">{{ task.titulo }}</h3>
                        <div class="flex flex-col gap-1">
                            {% if task.finalizado %}
                            <span class="flex-shrink-0 text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium">‚úì Finalizado</span>
                            {% elif task.em_andamento %}
                            <span class="flex-shrink-0 text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded-full font-medium">‚ö° Ativo</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Card Description -->
                    {% if task.descricao %}
                    <p class="text-sm text-gray-600 mb-3 line-clamp-2">{{ task.descricao }}</p>
                    {% endif %}

                    <!-- Quantidade Badge com Progresso -->
                    <div class="mb-3 space-y-2">
                        <div class="flex items-center justify-between text-xs">
                            <span class="text-gray-600 font-medium">Progresso:</span>
                            <span class="font-bold text-indigo-700">{{ task.quantidade_produzida }}/{{ task.quantidade_meta }}</span>
                        </div>
                        <!-- Barra de Progresso -->
                        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-2.5 rounded-full transition-all duration-300"
                                 style="width: {{ task.percentual_completo }}%"></div>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <span class="text-emerald-600 font-semibold">‚úì {{ task.quantidade_produzida }} feitas</span>
                            {% if task.quantidade_restante > 0 %}
                            <span class="text-orange-600 font-semibold">‚Ä¢ {{ task.quantidade_restante }} restantes</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Respons√°veis & Usu√°rios que trabalharam -->
                    <div class="mb-3">
                        {% if task.responsaveis.all %}
                        <div class="flex flex-wrap gap-1.5 mb-2">
                            {% for user in task.responsaveis.all %}
                            <div class="flex items-center gap-1 bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-xs font-medium">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                                </svg>
                                {{ user.get_full_name|default:user.username }}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Avatares dos usu√°rios que trabalharam neste card -->
                        {% regroup task.quantidades_feitas.all by usuario as usuarios_trabalharam %}
                        {% if usuarios_trabalharam %}
                        <div class="flex items-center gap-1">
                            <span class="text-xs text-gray-500">Trabalharam:</span>
                            <div class="flex -space-x-2">
                                {% for grupo in usuarios_trabalharam %}
                                {% if grupo.grouper %}
                                <div class="w-6 h-6 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white text-xs font-bold border-2 border-white" title="{{ grupo.grouper.get_full_name|default:grupo.grouper.username }}">
                                    {{ grupo.grouper.username|slice:":1"|upper }}
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Actions e Form de Quantidade (Alpine.js) -->
                    <div x-data="{ editQty: false }">
                        <!-- Actions (aparecem no hover) -->
                        <div class="no-drag opacity-0 group-hover:opacity-100 transition-opacity pt-2 border-t border-gray-100 flex flex-wrap gap-2">
                            <a href="{% url 'detalhe_tarefa' task_id=task.id %}" class="no-drag text-xs px-3 py-1.5 rounded-md bg-indigo-50 text-indigo-700 hover:bg-indigo-100 font-medium transition-colors">
                                üìã Detalhes
                            </a>
                            {% if not task.finalizado %}
                            <form method="post" action="{% url 'marcar_andamento' task_id=task.id %}" class="inline no-drag">
                                {% csrf_token %}
                                <button type="submit" class="no-drag text-xs px-3 py-1.5 rounded-md bg-blue-50 text-blue-700 hover:bg-blue-100 font-medium transition-colors">
                                    ‚ñ∂Ô∏è Iniciar
                                </button>
                            </form>
                            <form method="post" action="{% url 'finalizar' task_id=task.id %}" class="inline no-drag" onsubmit="return confirm('Tem certeza que deseja finalizar este card? Esta a√ß√£o marcar√° o card como conclu√≠do.')">
                                {% csrf_token %}
                                <button type="submit" class="no-drag text-xs px-3 py-1.5 rounded-md bg-emerald-50 text-emerald-700 hover:bg-emerald-100 font-medium transition-colors">
                                    ‚úì Finalizar
                                </button>
                            </form>
                            <button @click="editQty = !editQty" class="no-drag text-xs px-3 py-1.5 rounded-md bg-purple-50 text-purple-700 hover:bg-purple-100 font-medium transition-colors">
                                + Qtd
                            </button>
                            <a href="{% url 'editar_tarefa' task_id=task.id %}" class="no-drag text-xs px-3 py-1.5 rounded-md bg-gray-50 text-gray-700 hover:bg-gray-100 font-medium transition-colors">
                                ‚úèÔ∏è
                            </a>
                            {% else %}
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-green-600 font-medium">Finalizado em {{ task.data_finalizacao|date:'d/m/Y H:i' }}</span>
                                <form method="post" action="{% url 'desfinalizar' task_id=task.id %}" class="inline no-drag" onsubmit="return confirm('Deseja reabrir este card?')">
                                    {% csrf_token %}
                                    <button type="submit" class="no-drag text-xs px-3 py-1.5 rounded-md bg-yellow-50 text-yellow-700 hover:bg-yellow-100 font-medium transition-colors">
                                        ‚Ü©Ô∏è Reabrir
                                    </button>
                                </form>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Quick Add Quantity Form -->
                        <form x-show="editQty" x-transition method="post" action="{% url 'registrar_quantidade' task_id=task.id %}" class="no-drag mt-3 flex gap-2 items-center pt-2 border-t border-gray-100">
                        {% csrf_token %}
                        <input type="number" name="quantidade" min="1" class="no-drag flex-1 border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Quantidade" required>
                        <button type="submit" class="no-drag px-3 py-1.5 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 font-medium transition-colors text-sm">
                            Salvar
                        </button>
                        </form>
                    </div>
                </div>
            {% empty %}
                <div class="text-gray-400 text-sm italic text-center py-8">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                    </svg>
                    Nenhuma tarefa
                </div>
            {% endfor %}

            <!-- Add Card Button -->
            <div x-data="{ addingCard: false }">
                <button @click="addingCard = true" x-show="!addingCard" class="w-full py-2.5 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-all duration-200 font-medium">
                    + Adicionar card
                </button>

                <!-- Add Card Form -->
                <form x-show="addingCard" x-transition method="post" action="{% url 'criar_tarefa_coluna' coluna_id=coluna.id %}" class="bg-white rounded-lg border border-gray-300 shadow-md p-3 space-y-2">
                    {% csrf_token %}
                    <input type="text" name="titulo" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="T√≠tulo da tarefa" required autofocus>
                    <textarea name="descricao" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Descri√ß√£o (opcional)"></textarea>
                    <input type="number" name="quantidade" min="1" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Quantidade" required>
                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 font-medium transition-colors text-sm">
                            Adicionar
                        </button>
                        <button type="button" @click="addingCard = false" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors text-sm">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Add Column Card -->
    <div class="flex-shrink-0 w-80" x-data="{ addingColumn: false }">
        <button @click="addingColumn = true" x-show="!addingColumn" class="w-full h-full min-h-[120px] bg-white/60 backdrop-blur-sm hover:bg-white/80 border-2 border-dashed border-gray-300 rounded-xl transition-all duration-200 text-gray-600 hover:text-gray-900 hover:border-gray-400 font-medium">
            + Adicionar coluna
        </button>

        <!-- Add Column Form -->
        <div x-show="addingColumn" x-transition class="bg-white rounded-xl shadow-lg border border-gray-200 p-4" @click.stop>
            <form method="post" action="{% url 'criar_coluna' %}" class="space-y-3">
                {% csrf_token %}
                <input type="text" name="nome" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Nome da coluna" required autofocus>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-gray-700 font-medium">Cor:</label>
                    <input type="color" name="cor" class="w-12 h-10 rounded border border-gray-300 cursor-pointer" value="#3b82f6">
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="flex-1 px-3 py-2 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 font-medium transition-colors text-sm">
                        Criar
                    </button>
                    <button type="button" @click="addingColumn = false" class="px-3 py-2 rounded-md bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium transition-colors text-sm">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Hide elements with x-cloak before Alpine loads */
[x-cloak] { display: none !important; }

/* Scrollbar personalizado estilo Apple */
.scrollbar-hide::-webkit-scrollbar {
    height: 8px;
}
.scrollbar-hide::-webkit-scrollbar-track {
    background: transparent;
}
.scrollbar-hide::-webkit-scrollbar-thumb {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}
.scrollbar-hide::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 0, 0, 0.3);
}

/* Anima√ß√µes suaves */
.kanban-card {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
}

/* Melhora a √°rea arrast√°vel */
.kanban-card * {
    pointer-events: auto;
}

.kanban-card button,
.kanban-card a,
.kanban-card input,
.kanban-card form {
    cursor: pointer;
}

/* Elementos n√£o arrast√°veis */
.no-drag {
    cursor: auto !important;
}

.no-drag * {
    cursor: auto !important;
}

/* Line clamp para descri√ß√µes */
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

{% endblock %}

{% block javascript %}
<!-- SortableJS para drag and drop estilo Trello -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fun√ß√£o para obter o CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Sortable para colunas (arrastar colunas)
    const board = document.querySelector('.flex.gap-4.overflow-x-auto');
    if (board) {
        Sortable.create(board, {
            animation: 200,
            ghostClass: 'opacity-30',
            dragClass: 'rotate-2 scale-105',
            filter: '.flex-shrink-0:last-child', // Ignora o bot√£o de adicionar coluna
            draggable: '.kanban-column',
            onEnd: function(evt) {
                const columnId = evt.item.dataset.columnId;
                const newIndex = evt.newIndex;

                // Atualiza a ordem no servidor
                fetch(`/kanban/coluna/mover/${columnId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: `nova_ordem=${newIndex}`
                });
            }
        });
    }

    // Sortable para cards dentro de cada coluna
    const columns = document.querySelectorAll('.kanban-column > div.space-y-3');
    console.log('üîß Colunas encontradas para drag:', columns.length);
    console.log('üé¥ Cards totais na p√°gina:', document.querySelectorAll('.kanban-card').length);

    columns.forEach(column => {
        Sortable.create(column, {
            group: 'shared', // Permite arrastar entre colunas
            animation: 200,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            draggable: '.kanban-card', // Define o que √© arrast√°vel
            filter: '.no-drag', // Ignora elementos com classe no-drag
            preventOnFilter: true,
            onStart: function(evt) {
                console.log('üöÄ Come√ßou a arrastar card:', evt.item.dataset.taskId);
            },
            onEnd: function(evt) {
                const taskCard = evt.item;
                const taskId = taskCard.dataset.taskId;
                const newColumnElement = evt.to.closest('.kanban-column');
                const newColumnId = newColumnElement ? newColumnElement.dataset.columnId : null;
                const newIndex = evt.newIndex;

                console.log('üéØ Card arrastado:', { taskId, newColumnId, newIndex });

                if (taskId && newColumnId) {
                    // Atualiza no servidor
                    console.log('üì§ Enviando para servidor...');
                    fetch(`/kanban/tarefa/mover/${taskId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrftoken
                        },
                        body: `nova_coluna_id=${newColumnId}&nova_ordem=${newIndex}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('‚úÖ Card movido com sucesso!');
                            // Atualiza contadores de cards nas colunas
                            updateColumnCounts();
                        } else {
                            console.error('‚ùå Servidor retornou erro:', data);
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Erro ao mover card:', error);
                        // Reverte a mudan√ßa visual se houver erro
                        evt.from.insertBefore(taskCard, evt.from.children[evt.oldIndex]);
                        alert('Erro ao mover o card. Tente novamente.');
                    });
                } else {
                    console.warn('‚ö†Ô∏è Faltando taskId ou newColumnId:', { taskId, newColumnId });
                }
            }
        });
    });

    // Atualiza contadores de cards em cada coluna
    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const counter = column.querySelector('.bg-gray-100.px-2.py-0\\.5.rounded-full');
            const cardsContainer = column.querySelector('.space-y-3');
            const cardCount = cardsContainer.querySelectorAll('.kanban-card').length;
            if (counter) {
                counter.textContent = cardCount;
            }
        });
    }
});
</script>

<style>
/* Anima√ß√µes extras para drag and drop */
.sortable-ghost {
    opacity: 0.3 !important;
    background: rgba(99, 102, 241, 0.1) !important;
}

.sortable-drag {
    transform: rotate(2deg) scale(1.05);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    cursor: grabbing !important;
}

.kanban-card:active {
    cursor: grabbing;
}

.kanban-column:active {
    cursor: grabbing;
}
</style>
{% endblock %}
