{% extends 'core/base.html' %}

{% block content %}
<div x-data="{
    itemCount: {{ item_formset.total_form_count|default:1 }},
    docCount: {{ documento_formset.total_form_count|default:1 }},
    imgCount: {{ imagem_formset.total_form_count|default:1 }},
    imagePreviews: {},
    saving: false
}" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

    <!-- Breadcrumbs -->
    <nav class="mb-6 text-sm">
        <ol class="flex items-center space-x-2 text-gray-600">
            <li><a href="{% url 'lista_expedicoes' %}" class="hover:text-indigo-600 transition-colors">üì¶ Expedi√ß√µes</a></li>
            <li><span class="text-gray-400">/</span></li>
            <li class="text-gray-900 font-semibold">Nova Expedi√ß√£o</li>
        </ol>
    </nav>

    <!-- Cabe√ßalho -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
        <div class="flex items-center space-x-3">
            <div class="bg-indigo-100 rounded-lg p-3">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Registrar Nova Expedi√ß√£o</h1>
                <p class="text-gray-600 mt-1">Preencha os dados da expedi√ß√£o de produtos</p>
            </div>
        </div>
    </div>

    <!-- Formul√°rio -->
    <form method="post" enctype="multipart/form-data" @submit="saving = true">
        {% csrf_token %}

        <!-- Informa√ß√µes Principais -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Informa√ß√µes Principais
            </h2>

            {% if user.is_superuser %}
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-2">{{ form.empresa.label }}</label>
                    {{ form.empresa }}
                    {% if form.empresa.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.empresa.errors.0 }}</p>
                    {% endif %}
                </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Cliente -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">{{ form.cliente.label }}</label>
                    {{ form.cliente }}
                    {% if form.cliente.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.cliente.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Nota Fiscal -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">{{ form.nota_fiscal.label }}</label>
                    {{ form.nota_fiscal }}
                    {% if form.nota_fiscal.errors %}
                        <p class="text-red-600 text-sm mt-1">{{ form.nota_fiscal.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Observa√ß√µes -->
            <div class="mt-6">
                <label class="block text-sm font-bold text-gray-700 mb-2">{{ form.observacoes.label }}</label>
                {{ form.observacoes }}
                {% if form.observacoes.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.observacoes.errors.0 }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Itens a Enviar -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Itens a Enviar
            </h2>

            {{ item_formset.management_form }}

            <div class="hidden md:grid grid-cols-[1fr,150px] gap-4 mb-3 px-3">
                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Produto</span>
                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Quantidade</span>
            </div>

            <div id="item-formset" class="space-y-3">
                {% for item_form in item_formset %}
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-[1fr,150px] gap-4">
                            <div>
                                <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Produto</label>
                                {{ item_form.produto }}
                                {% if item_form.produto.errors %}
                                    <p class="text-red-600 text-sm mt-1">{{ item_form.produto.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Quantidade</label>
                                {{ item_form.quantidade }}
                                {% if item_form.quantidade.errors %}
                                    <p class="text-red-600 text-sm mt-1">{{ item_form.quantidade.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button"
                    @click="
                        let itemTemplate = document.getElementById('empty-item-form-template').innerHTML;
                        let newItemForm = itemTemplate.replace(/__prefix__/g, itemCount);
                        document.getElementById('item-formset').insertAdjacentHTML('beforeend', newItemForm);
                        document.getElementById('id_itens-TOTAL_FORMS').value = itemCount + 1;
                        itemCount++;
                    "
                    class="mt-4 inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 font-semibold rounded-lg hover:bg-indigo-200 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Adicionar Outro Item
            </button>

            <template id="empty-item-form-template">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-[1fr,150px] gap-4">
                        <div>
                            <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Produto</label>
                            {{ item_formset.empty_form.produto }}
                        </div>
                        <div>
                            <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Quantidade</label>
                            {{ item_formset.empty_form.quantidade }}
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Fotos da Expedi√ß√£o -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                Fotos da Expedi√ß√£o
            </h2>

            {{ imagem_formset.management_form }}

            <div id="image-formset" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for img_form in imagem_formset %}
                    <div class="relative bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300 hover:border-indigo-400 transition-colors">
                        <input type="file"
                               name="{{ img_form.imagem.name }}"
                               accept="image/*"
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                               @change="
                                   const file = $event.target.files[0];
                                   const id = 'preview-{{ forloop.counter0 }}';
                                   if (file) {
                                       const reader = new FileReader();
                                       reader.onload = (e) => { imagePreviews[id] = e.target.result; };
                                       reader.readAsDataURL(file);
                                   } else {
                                       delete imagePreviews[id];
                                   }
                               ">
                        <div x-show="imagePreviews['preview-{{ forloop.counter0 }}']" class="mt-3">
                            <img :src="imagePreviews['preview-{{ forloop.counter0 }}']" class="w-full h-40 object-cover rounded-lg">
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button"
                    @click="
                        let imgTemplate = document.getElementById('empty-image-form-template').innerHTML;
                        let newImgForm = imgTemplate.replace(/__prefix__/g, imgCount);
                        document.getElementById('image-formset').insertAdjacentHTML('beforeend', newImgForm);
                        document.getElementById('id_imagens-TOTAL_FORMS').value = imgCount + 1;
                        imgCount++;
                    "
                    class="mt-4 inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 font-semibold rounded-lg hover:bg-indigo-200 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Adicionar Outra Foto
            </button>

            <template id="empty-image-form-template">
                <div class="relative bg-gray-50 rounded-lg p-4 border-2 border-dashed border-gray-300 hover:border-indigo-400 transition-colors">
                    {{ imagem_formset.empty_form.imagem }}
                </div>
            </template>
        </div>

        <!-- Documentos da Expedi√ß√£o -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                </svg>
                Documentos da Expedi√ß√£o
            </h2>

            {{ documento_formset.management_form }}

            <div class="hidden md:grid grid-cols-2 gap-4 mb-3 px-3">
                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Arquivo</span>
                <span class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Tipo</span>
            </div>

            <div id="document-formset" class="space-y-3">
                {% for doc_form in documento_formset %}
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Arquivo</label>
                                {{ doc_form.documento }}
                                {% if doc_form.documento.errors %}
                                    <p class="text-red-600 text-sm mt-1">{{ doc_form.documento.errors.0 }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Tipo</label>
                                {{ doc_form.tipo }}
                                {% if doc_form.tipo.errors %}
                                    <p class="text-red-600 text-sm mt-1">{{ doc_form.tipo.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <button type="button"
                    @click="
                        let docTemplate = document.getElementById('empty-document-form-template').innerHTML;
                        let newDocForm = docTemplate.replace(/__prefix__/g, docCount);
                        document.getElementById('document-formset').insertAdjacentHTML('beforeend', newDocForm);
                        document.getElementById('id_documentos-TOTAL_FORMS').value = docCount + 1;
                        docCount++;
                    "
                    class="mt-4 inline-flex items-center px-4 py-2 bg-indigo-100 text-indigo-700 font-semibold rounded-lg hover:bg-indigo-200 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Adicionar Outro Documento
            </button>

            <template id="empty-document-form-template">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Arquivo</label>
                            {{ documento_formset.empty_form.documento }}
                        </div>
                        <div>
                            <label class="block md:hidden text-xs font-semibold text-gray-500 mb-1">Tipo</label>
                            {{ documento_formset.empty_form.tipo }}
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3">
                <a href="{% url 'lista_expedicoes' %}"
                   class="inline-flex justify-center items-center px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Cancelar
                </a>
                <button type="submit"
                        :disabled="saving"
                        class="inline-flex justify-center items-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span x-text="saving ? 'Registrando...' : 'Registrar Expedi√ß√£o'"></span>
                </button>
            </div>
        </div>
    </form>

</div>
{% endblock %}
