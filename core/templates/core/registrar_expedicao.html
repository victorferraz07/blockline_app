{% extends 'core/base.html' %}
{% block content %}
<div x-data="{ 
    itemCount: {{ item_formset.total_form_count|default:1 }}, 
    docCount: {{ documento_formset.total_form_count|default:1 }}, 
    imgCount: {{ imagem_formset.total_form_count|default:1 }} 
}" class="container mx-auto">
    <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Registrar Nova Expedição</h1>
        
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            {% if user.is_superuser %}
                <div class="mb-4">
                    {{ form.empresa.label_tag }}
                    {{ form.empresa }}
                    {{ form.empresa.errors }}
                </div>
            {% endif %}

            {% for field in form %}
                {% if field.name != 'empresa' %}
                    <div class="mb-4">
                        {{ field.label_tag }}
                        {{ field }}
                        {{ field.errors }}
                    </div>
                {% endif %}
            {% endfor %}


            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Itens a Enviar</h2>
            {{ item_formset.management_form }}
            <div class="grid grid-cols-[1fr,auto] gap-x-4 mb-2 px-2">
                <span class="text-sm font-medium text-gray-500">Produto</span>
                <span class="text-sm font-medium text-gray-500">Quantidade</span>
            </div>
            <div id="item-formset" class="space-y-2">
                {% for item_form in item_formset %}
                    <div class="grid grid-cols-[1fr,120px] items-start gap-4 p-2 border rounded">
                        <div>{{ item_form.produto }}<div class="text-red-500 text-sm mt-1">{{ item_form.produto.errors }}</div></div>
                        <div>{{ item_form.quantidade }}<div class="text-red-500 text-sm mt-1">{{ item_form.quantidade.errors }}</div></div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" @click="
                let itemTemplate = document.getElementById('empty-item-form-template').innerHTML;
                let newItemForm = itemTemplate.replace(/__prefix__/g, itemCount);
                document.getElementById('item-formset').insertAdjacentHTML('beforeend', newItemForm);
                document.getElementById('id_itens-TOTAL_FORMS').value = itemCount + 1;
                itemCount++;
            " class="mt-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800">+ Adicionar Outro Item</button>
            <template id="empty-item-form-template">
                <div class="grid grid-cols-[1fr,120px] items-start gap-4 p-2 border rounded mt-2">
                    <div>{{ item_formset.empty_form.produto }}</div>
                    <div>{{ item_formset.empty_form.quantidade }}</div>
                </div>
            </template>

            <hr class="my-8">

            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Fotos da Expedição</h2>
            {{ imagem_formset.management_form }}
            <div id="image-formset" class="space-y-4">
                {% for img_form in imagem_formset %}
                <div class="p-2 border rounded">
                    {{ img_form.imagem }}
                </div>
                {% endfor %}
            </div>
            <button type="button" @click="
                let imgTemplate = document.getElementById('empty-image-form-template').innerHTML;
                let newImgForm = imgTemplate.replace(/__prefix__/g, imgCount);
                document.getElementById('image-formset').insertAdjacentHTML('beforeend', newImgForm);
                document.getElementById('id_imagens-TOTAL_FORMS').value = imgCount + 1;
                imgCount++;
            " class="mt-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800">+ Adicionar Outra Foto</button>
            <template id="empty-image-form-template">
                <div class="p-2 border rounded mt-2">{{ imagem_formset.empty_form.imagem }}</div>
            </template>

            <hr class="my-8">

            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Documentos da Expedição</h2>
            {{ documento_formset.management_form }}
            <div id="document-formset" class="space-y-2">
                {% for doc_form in documento_formset %}
                    <div class="grid grid-cols-[1fr,1fr] items-end gap-4 p-2 border rounded">
                        <div>{{ doc_form.documento }}<div class="text-red-500 text-sm mt-1">{{ doc_form.documento.errors }}</div></div>
                        <div>{{ doc_form.tipo }}<div class="text-red-500 text-sm mt-1">{{ doc_form.tipo.errors }}</div></div>
                    </div>
                {% endfor %}
            </div>
            <button type="button" @click="
                let docTemplate = document.getElementById('empty-document-form-template').innerHTML;
                let newDocForm = docTemplate.replace(/__prefix__/g, docCount);
                document.getElementById('document-formset').insertAdjacentHTML('beforeend', newDocForm);
                document.getElementById('id_documentos-TOTAL_FORMS').value = docCount + 1;
                docCount++;
            " class="mt-2 text-sm text-indigo-600 font-semibold hover:text-indigo-800">+ Adicionar Outro Documento</button>
            <template id="empty-document-form-template">
                <div class="grid grid-cols-[1fr,1fr] items-end gap-4 p-2 border rounded mt-2">
                    <div>{{ documento_formset.empty_form.documento }}</div>
                    <div>{{ documento_formset.empty_form.tipo }}</div>
                </div>
            </template>

            <div class="flex justify-end mt-8 border-t pt-6">
                <a href="{% url 'lista_expedicoes' %}" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 mr-4 font-semibold">Cancelar</a>
                <button type="submit" class="bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 font-semibold">Registrar Expedição</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}