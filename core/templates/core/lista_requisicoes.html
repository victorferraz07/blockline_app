{% extends 'core/base.html' %}
{% load static %}
{% block content %}

<div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50"></div>

<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">üõí Compras</h1>
            <p class="text-gray-600 mt-1">Gerencie o fluxo de compras da empresa</p>
        </div>
        <button onclick="document.getElementById('modal-nova-requisicao').style.display='flex'"
                class="btn-mobile px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors tap-feedback">
            + Nova Compra
        </button>
    </div>

    <!-- Alerta de Filtro por NF -->
    {% if nf_filtro %}
    <div class="mb-6 bg-indigo-50 border-2 border-indigo-300 rounded-xl p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üîó</span>
                <div>
                    <p class="font-semibold text-indigo-900">Filtrado por Nota Fiscal</p>
                    <p class="text-sm text-indigo-700">Mostrando requisi√ß√µes com NF: <span class="font-bold">{{ nf_filtro }}</span></p>
                </div>
            </div>
            <a href="{% url 'lista_requisicoes' %}?status={{ status_filtro }}"
               class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors">
                Limpar Filtro
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Cards de Estat√≠sticas -->
    <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
        <a href="?status=pendente" class="bg-white rounded-xl shadow-sm border-2 {% if status_filtro == 'pendente' %}border-yellow-500{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Aguardando Aprova√ß√£o</span>
                <span class="text-2xl">‚è≥</span>
            </div>
            <p class="text-3xl font-bold text-yellow-600">{{ total_pendente }}</p>
        </a>

        <a href="?status=aprovado" class="bg-white rounded-xl shadow-sm border-2 {% if status_filtro == 'aprovado' %}border-blue-500{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Aguardando Compra</span>
                <span class="text-2xl">‚úÖ</span>
            </div>
            <p class="text-3xl font-bold text-blue-600">{{ total_aprovado }}</p>
        </a>

        <a href="?status=comprado" class="bg-white rounded-xl shadow-sm border-2 {% if status_filtro == 'comprado' %}border-purple-500{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Aguardando Recebimento</span>
                <span class="text-2xl">üì¶</span>
            </div>
            <p class="text-3xl font-bold text-purple-600">{{ total_comprado }}</p>
        </a>

        <a href="?status=recebido" class="bg-white rounded-xl shadow-sm border-2 {% if status_filtro == 'recebido' %}border-green-500{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Conclu√≠dos</span>
                <span class="text-2xl">‚úîÔ∏è</span>
            </div>
            <p class="text-3xl font-bold text-green-600">{{ total_recebido }}</p>
        </a>

        <a href="?status=rejeitado" class="bg-white rounded-xl shadow-sm border-2 {% if status_filtro == 'rejeitado' %}border-red-500{% else %}border-gray-200{% endif %} p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-semibold text-gray-600">Rejeitados</span>
                <span class="text-2xl">‚ùå</span>
            </div>
            <p class="text-3xl font-bold text-red-600">{{ total_rejeitado }}</p>
        </a>
    </div>

    <!-- Filtro -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
        <div class="flex flex-wrap gap-2">
            <a href="?status=todas" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'todas' %}bg-gray-800 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                üìã Todas
            </a>
            <a href="?status=pendente" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'pendente' %}bg-yellow-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                ‚è≥ Pendentes
            </a>
            <a href="?status=aprovado" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'aprovado' %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                ‚úÖ Aprovados
            </a>
            <a href="?status=comprado" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'comprado' %}bg-purple-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                üõí Comprados
            </a>
            <a href="?status=recebido" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'recebido' %}bg-green-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                üì¶ Recebidos
            </a>
            <a href="?status=rejeitado" class="px-4 py-2 rounded-lg font-semibold {% if status_filtro == 'rejeitado' %}bg-red-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %} transition-colors">
                ‚ùå Rejeitados
            </a>
        </div>
    </div>

    <!-- Lista de Requisi√ß√µes -->
    <div class="space-y-4">
        {% for req in requisicoes %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-all" x-data="{
            showDetails: false,
            showEdit: false,
            showApprove: false,
            showReject: false,
            showBuy: false,
            showRejectBuy: false,
            showReceive: false
        }">
            <!-- Cabe√ßalho da Compra -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                <div class="flex-1">
                    <h3 class="text-xl font-bold text-gray-900">{{ req.item }}</h3>
                    <p class="text-sm text-gray-600 mt-1">{{ req.descricao|truncatewords:15 }}</p>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">üë§ {{ req.requerente.username }}</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">üìÖ {{ req.data_requisicao|date:'d/m/Y H:i' }}</span>
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">üí∞ R$ {{ req.valor_total_estimado|floatformat:2 }}</span>
                    </div>
                </div>
                <div>
                    <span class="inline-block px-4 py-2 rounded-lg font-semibold
                        {% if req.status == 'pendente' %}bg-yellow-100 text-yellow-800
                        {% elif req.status == 'aprovado' %}bg-blue-100 text-blue-800
                        {% elif req.status == 'comprado' %}bg-purple-100 text-purple-800
                        {% elif req.status == 'recebido' %}bg-green-100 text-green-800
                        {% elif req.status == 'rejeitado' %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ req.get_status_display }}
                    </span>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-wrap gap-2">
                <button @click="showDetails = !showDetails"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold transition-colors">
                    <span x-show="!showDetails">üìã Ver Detalhes</span>
                    <span x-show="showDetails">‚úï Fechar</span>
                </button>

                <button @click="showEdit = !showEdit"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold transition-colors tap-feedback">
                    <span x-show="!showEdit">‚úèÔ∏è Editar</span>
                    <span x-show="showEdit">‚úï Fechar</span>
                </button>

                {% if req.status == 'comprado' %}
                <button @click="showReceive = !showReceive"
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold transition-colors tap-feedback">
                    üì¶ Marcar como Recebido
                </button>
                {% endif %}
            </div>

            <!-- Detalhes da Compra -->
            <div x-show="showDetails" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Informa√ß√µes do Item</h4>
                        <p class="text-sm"><strong>Quantidade:</strong> {{ req.quantidade }} {{ req.unidade }}</p>
                        <p class="text-sm"><strong>Pre√ßo Estimado:</strong> R$ {{ req.preco_estimado|floatformat:2 }}</p>
                        <p class="text-sm"><strong>Total Estimado:</strong> R$ {{ req.valor_total_estimado|floatformat:2 }}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Informa√ß√µes da Compra</h4>
                        <p class="text-sm"><strong>Prop√≥sito:</strong> {{ req.proposito }}</p>
                        {% if req.projeto %}<p class="text-sm"><strong>Projeto:</strong> {{ req.projeto }}</p>{% endif %}
                        <p class="text-sm"><strong>Requerente:</strong> {{ req.requerente.get_full_name|default:req.requerente.username }}</p>
                    </div>
                </div>

                {% if req.status == 'pendente' %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-3">A√ß√µes de Aprova√ß√£o</h4>
                    <div class="flex flex-wrap gap-2">
                        <button @click="showApprove = !showApprove"
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold transition-colors tap-feedback">
                            ‚úÖ Aprovar
                        </button>
                        <button @click="showReject = !showReject"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold transition-colors tap-feedback">
                            ‚ùå Rejeitar
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if req.status == 'aprovado' %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-3">A√ß√µes de Compra</h4>
                    <div class="flex flex-wrap gap-2">
                        <button @click="showBuy = !showBuy"
                                class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold transition-colors tap-feedback">
                            üõí Marcar como Comprado
                        </button>
                    </div>
                </div>
                {% endif %}

                {% if req.status == 'rejeitado' %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-red-700 mb-2">Informa√ß√µes da Rejei√ß√£o</h4>
                    {% if req.aprovado_por %}
                    <p class="text-sm">‚ùå <strong>Rejeitado por:</strong> {{ req.aprovado_por.username }} em {{ req.data_aprovacao|date:'d/m/Y H:i' }}</p>
                    {% if req.observacao_aprovacao %}<p class="text-sm text-red-600 ml-6 mt-1"><strong>Motivo:</strong> {{ req.observacao_aprovacao }}</p>{% endif %}
                    {% endif %}
                </div>
                {% endif %}

                {% if req.status != 'pendente' and req.status != 'rejeitado' %}
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-2">Hist√≥rico</h4>
                    {% if req.aprovado_por %}
                    <p class="text-sm">‚úÖ <strong>Aprovado por:</strong> {{ req.aprovado_por.username }} em {{ req.data_aprovacao|date:'d/m/Y H:i' }}</p>
                    {% if req.observacao_aprovacao %}<p class="text-sm text-gray-600 ml-6">{{ req.observacao_aprovacao }}</p>{% endif %}
                    {% if req.documento_aprovacao %}
                    <p class="text-sm ml-6 mt-1">
                        <a href="{{ req.documento_aprovacao.url }}" target="_blank" class="inline-flex items-center gap-1 text-indigo-600 hover:text-indigo-800 hover:underline">
                            üìé Ver documento anexado
                        </a>
                    </p>
                    {% endif %}
                    {% endif %}

                    {% if req.comprado_por %}
                    <p class="text-sm mt-2">üõí <strong>Comprado por:</strong> {{ req.comprado_por.username }} em {{ req.data_compra|date:'d/m/Y H:i' }}</p>
                    <p class="text-sm ml-6"><strong>Pre√ßo Real:</strong> R$ {{ req.preco_real|floatformat:2 }}</p>
                    {% if req.fornecedor %}<p class="text-sm ml-6"><strong>Fornecedor:</strong> {{ req.fornecedor.nome }}</p>{% endif %}
                    {% if req.nota_fiscal %}
                    <p class="text-sm ml-6">
                        <strong>NF:</strong>
                        <a href="{% url 'lista_recebimentos' %}?q={{ req.nota_fiscal }}"
                           class="text-indigo-600 hover:text-indigo-800 hover:underline font-semibold"
                           title="Ver recebimento desta nota fiscal">
                            {{ req.nota_fiscal }} üîó
                        </a>
                    </p>
                    {% endif %}
                    {% if req.data_entrega_prevista %}<p class="text-sm ml-6"><strong>üìÖ Entrega Prevista:</strong> {{ req.data_entrega_prevista|date:'d/m/Y' }}</p>{% endif %}
                    {% endif %}

                    {% if req.recebido_por %}
                    <p class="text-sm mt-2">üì¶ <strong>Recebido por:</strong> {{ req.recebido_por.username }} em {{ req.data_recebimento|date:'d/m/Y H:i' }}</p>
                    {% if req.observacao_recebimento %}<p class="text-sm text-gray-600 ml-6">{{ req.observacao_recebimento }}</p>{% endif %}

                    <!-- Hist√≥rico de Altera√ß√µes (apenas em recebidos) -->
                    {% if req.historico.all %}
                    <div class="mt-4 pt-3 border-t border-gray-300">
                        <h5 class="font-semibold text-gray-700 mb-3">üìù Hist√≥rico de Altera√ß√µes</h5>
                        <div class="space-y-3">
                            {% for hist in req.historico.all %}
                            <div class="bg-gray-50 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-gray-700">{{ hist.tipo_alteracao }}</span>
                                    <span class="text-xs text-gray-500">{{ hist.data_alteracao|date:'d/m/Y H:i' }}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-1">
                                    <strong>Usu√°rio:</strong> {{ hist.usuario.get_full_name|default:hist.usuario.username }}
                                </p>
                                <div class="text-sm text-gray-700 whitespace-pre-line bg-white rounded p-2 mt-2">{{ hist.descricao }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Form de Edi√ß√£o -->
            <div x-show="showEdit" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <form method="post" action="{% url 'editar_requisicao' req.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h4 class="font-semibold text-blue-700 mb-4">‚úèÔ∏è Editar Compra Completa</h4>

                    <!-- Informa√ß√µes B√°sicas -->
                    <div class="mb-6">
                        <h5 class="font-semibold text-gray-800 mb-3 pb-2 border-b">üì¶ Informa√ß√µes B√°sicas</h5>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Item *</label>
                                <input type="text" name="item" value="{{ req.item }}" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Descri√ß√£o *</label>
                                <textarea name="descricao" rows="3" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ req.descricao }}</textarea>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade *</label>
                                    <input type="number" step="0.01" name="quantidade" value="{{ req.quantidade }}" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Unidade</label>
                                    <select name="unidade" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="un" {% if req.unidade == 'un' %}selected{% endif %}>un</option>
                                        <option value="kg" {% if req.unidade == 'kg' %}selected{% endif %}>kg</option>
                                        <option value="m" {% if req.unidade == 'm' %}selected{% endif %}>m</option>
                                        <option value="l" {% if req.unidade == 'l' %}selected{% endif %}>l</option>
                                        <option value="cx" {% if req.unidade == 'cx' %}selected{% endif %}>cx</option>
                                        <option value="rolo" {% if req.unidade == 'rolo' %}selected{% endif %}>rolo</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Pre√ßo Est. (R$) *</label>
                                    <input type="number" step="0.01" name="preco_estimado" value="{{ req.preco_estimado }}" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Prop√≥sito *</label>
                                    <input type="text" name="proposito" value="{{ req.proposito }}" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Projeto (opcional)</label>
                                    <input type="text" name="projeto" value="{{ req.projeto|default:'' }}" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Link do Item (opcional)</label>
                                <input type="url" name="link_item" value="{{ req.link_item|default:'' }}" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="https://exemplo.com/produto">
                            </div>
                        </div>
                    </div>

                    <!-- Dados de Aprova√ß√£o -->
                    {% if req.status != 'pendente' %}
                    <div class="mb-6">
                        <h5 class="font-semibold text-gray-800 mb-3 pb-2 border-b">‚úÖ Dados de Aprova√ß√£o</h5>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Observa√ß√£o de Aprova√ß√£o</label>
                                <textarea name="observacao_aprovacao" rows="2" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ req.observacao_aprovacao|default:'' }}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìé Atualizar Documento de Aprova√ß√£o</label>
                                <input type="file" name="documento_aprovacao" accept="image/*,.pdf,.doc,.docx" class="w-full border border-gray-300 rounded-lg px-4 py-2 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                {% if req.documento_aprovacao %}
                                <p class="text-xs text-gray-500 mt-1">Arquivo atual: <a href="{{ req.documento_aprovacao.url }}" target="_blank" class="text-blue-600 hover:underline">Ver documento</a></p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Dados de Compra -->
                    {% if req.status == 'comprado' or req.status == 'recebido' %}
                    <div class="mb-6">
                        <h5 class="font-semibold text-gray-800 mb-3 pb-2 border-b">üõí Dados de Compra</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Pre√ßo Real (R$)</label>
                                <input type="number" step="0.01" name="preco_real" value="{{ req.preco_real|default:'' }}" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Fornecedor</label>
                                <select name="fornecedor_id" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Selecione...</option>
                                    {% for forn in fornecedores %}
                                    <option value="{{ forn.id }}" {% if req.fornecedor and req.fornecedor.id == forn.id %}selected{% endif %}>{{ forn.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Dados de Recebimento -->
                    {% if req.status == 'comprado' or req.status == 'recebido' %}
                    <div class="mb-6">
                        <h5 class="font-semibold text-gray-800 mb-3 pb-2 border-b">üì¶ Dados de Recebimento</h5>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nota Fiscal</label>
                                    <input type="text" name="nota_fiscal" value="{{ req.nota_fiscal|default:'' }}" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Data de Entrega Prevista</label>
                                    <input type="date" name="data_entrega_prevista" value="{% if req.data_entrega_prevista %}{{ req.data_entrega_prevista|date:'Y-m-d' }}{% endif %}" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            {% if req.status == 'recebido' %}
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Observa√ß√£o de Recebimento</label>
                                <textarea name="observacao_recebimento" rows="2" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ req.observacao_recebimento|default:'' }}</textarea>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                            üíæ Salvar Todas as Altera√ß√µes
                        </button>
                        <button type="button" @click="showEdit = false" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Form de Aprova√ß√£o -->
            <div x-show="showApprove" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <form method="post" action="{% url 'aprovar_requisicao' req.id %}">
                    {% csrf_token %}
                    <h4 class="font-semibold text-green-700 mb-3">‚úÖ Aprovar Compra</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observa√ß√£o (opcional)</label>
                        <textarea name="observacao" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Adicione uma observa√ß√£o..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">Confirmar</button>
                        <button type="button" @click="showApprove = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Form de Rejei√ß√£o -->
            <div x-show="showReject" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <form method="post" action="{% url 'rejeitar_requisicao' req.id %}">
                    {% csrf_token %}
                    <h4 class="font-semibold text-red-700 mb-3">‚ùå Rejeitar Compra</h4>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Motivo da Rejei√ß√£o (opcional)</label>
                    <textarea name="observacao" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3" placeholder="Explique o motivo da rejei√ß√£o..."></textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">Confirmar</button>
                        <button type="button" @click="showReject = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Form de Compra -->
            <div x-show="showBuy" x-transition class="mt-4 pt-4 border-t border-gray-200" x-data="{ formaPagamento: '' }">
                <form method="post" action="{% url 'marcar_como_comprado' req.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h4 class="font-semibold text-purple-700 mb-3">üõí Marcar como Comprado</h4>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pre√ßo Real (R$) *</label>
                            <input type="number" step="0.01" name="preco_real" required class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                    </div>

                    <!-- Fornecedor: Escolher entre cadastrado ou digitar -->
                    <div class="mb-3" x-data="{ tipoFornecedor: 'cadastrado' }">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Fornecedor</label>

                        <div class="flex gap-4 mb-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="tipo_fornecedor" value="cadastrado" x-model="tipoFornecedor" class="mr-2">
                                <span class="text-sm">Fornecedor cadastrado</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="tipo_fornecedor" value="digitado" x-model="tipoFornecedor" class="mr-2">
                                <span class="text-sm">Digitar nome</span>
                            </label>
                        </div>

                        <div x-show="tipoFornecedor === 'cadastrado'" x-transition>
                            <select name="fornecedor_id" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                                <option value="">Selecione...</option>
                                {% for forn in fornecedores %}
                                <option value="{{ forn.id }}">{{ forn.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div x-show="tipoFornecedor === 'digitado'" x-transition>
                            <input type="text" name="fornecedor_nome_digitado" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Digite o nome do fornecedor">
                        </div>
                    </div>

                    <!-- Forma de Pagamento -->
                    <div class="mb-3">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Forma de Pagamento</label>
                        <select name="forma_pagamento" x-model="formaPagamento" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <option value="">Selecione...</option>
                            <option value="pix">PIX</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="transferencia_bancaria">Transfer√™ncia Banc√°ria</option>
                            <option value="boleto">Boleto</option>
                            <option value="cartao">Cart√£o</option>
                        </select>
                    </div>

                    <!-- Campos espec√≠ficos para BOLETO (condicionais) -->
                    <div x-show="formaPagamento === 'boleto'" x-transition class="border-2 border-orange-200 bg-orange-50 rounded-lg p-4 mb-3">
                        <h5 class="font-semibold text-orange-700 mb-3">üìã Dados do Boleto</h5>

                        <!-- Dias de Anteced√™ncia para Aviso -->
                        <div class="mb-3">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Dias de Anteced√™ncia para Aviso</label>
                            <input type="number" name="dias_aviso_pagamento" value="3" min="1" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                            <p class="text-xs text-gray-500 mt-1">Quantos dias antes do vencimento voc√™ quer receber o alerta por email</p>
                        </div>

                        <div class="mb-3" x-data="{
                            tipoDias: '',
                            datasVencimento: [],
                            dataInicial: '',
                            quantidadeParcelas: 3,
                            get datasCalculadas() {
                                if (!this.dataInicial || !this.quantidadeParcelas) return [];
                                const intervalo = this.tipoDias === '15_em_15' ? 15 : 30;
                                const datas = [];
                                const inicial = new Date(this.dataInicial + 'T00:00:00');
                                for (let i = 0; i < this.quantidadeParcelas; i++) {
                                    const data = new Date(inicial);
                                    data.setDate(data.getDate() + (intervalo * i));
                                    datas.push(data);
                                }
                                return datas;
                            }
                        }">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Datas de Vencimento</label>

                            <select name="tipo_dias_pagamento" x-model="tipoDias" class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3">
                                <option value="">Selecione...</option>
                                <option value="15_em_15">De 15 em 15 dias</option>
                                <option value="30_em_30">De 30 em 30 dias</option>
                                <option value="especificos">Selecionar datas espec√≠ficas</option>
                            </select>

                            <!-- Quando escolher "15 em 15" ou "30 em 30", mostrar data inicial e parcelas -->
                            <div x-show="tipoDias === '15_em_15' || tipoDias === '30_em_30'" x-transition class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-blue-700 mb-3">üìÖ Configurar Pagamentos Recorrentes</h5>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Data da 1¬™ Parcela</label>
                                        <input type="date" x-model="dataInicial" name="data_inicial_boleto" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade de Parcelas</label>
                                        <input type="number" x-model.number="quantidadeParcelas" name="quantidade_parcelas_calc" min="1" max="24" class="w-full border border-gray-300 rounded-lg px-4 py-2" value="3">
                                    </div>
                                </div>

                                <!-- Preview das datas calculadas -->
                                <div x-show="dataInicial && quantidadeParcelas > 0" x-transition class="bg-white border-2 border-blue-300 rounded-lg p-3 mb-3">
                                    <h6 class="text-sm font-bold text-blue-700 mb-2">üìÖ Datas de Vencimento:</h6>
                                    <div class="space-y-1">
                                        <template x-for="(data, index) in datasCalculadas" :key="index">
                                            <div class="flex items-center gap-2 text-sm">
                                                <span class="font-semibold text-blue-600" x-text="`${index + 1}¬™ parcela:`"></span>
                                                <span class="text-gray-700" x-text="data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <p class="text-xs text-gray-500">
                                    <strong>Como funciona:</strong>
                                    <span x-show="tipoDias === '15_em_15'">O sistema calcula as datas somando 15 dias a cada parcela.</span>
                                    <span x-show="tipoDias === '30_em_30'">O sistema calcula as datas somando 30 dias a cada parcela.</span>
                                </p>
                            </div>

                            <!-- Quando escolher "datas espec√≠ficas", mostrar calend√°rio -->
                            <div x-show="tipoDias === 'especificos'" x-transition class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-3">üìÖ Datas de Vencimento dos Boletos</label>

                                <!-- Lista de datas adicionadas -->
                                <div class="mb-3 space-y-2" x-show="datasVencimento.length > 0">
                                    <template x-for="(data, index) in datasVencimento" :key="index">
                                        <div class="flex items-center gap-2 bg-white p-2 rounded-lg border border-orange-300">
                                            <span class="flex-1 text-sm font-semibold text-gray-700" x-text="new Date(data).toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' })"></span>
                                            <button type="button" @click="datasVencimento.splice(index, 1)" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs font-semibold">
                                                ‚úï Remover
                                            </button>
                                        </div>
                                    </template>
                                </div>

                                <!-- Adicionar nova data -->
                                <div class="flex gap-2">
                                    <input type="date" x-ref="novaData" class="flex-1 border border-gray-300 rounded-lg px-4 py-2">
                                    <button type="button" @click="
                                        const valor = $refs.novaData.value;
                                        if (valor && !datasVencimento.includes(valor)) {
                                            datasVencimento.push(valor);
                                            datasVencimento.sort();
                                            $refs.novaData.value = '';
                                        }
                                    " class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-semibold whitespace-nowrap">
                                        ‚ûï Adicionar Data
                                    </button>
                                </div>

                                <p class="text-xs text-gray-500 mt-2">
                                    <strong>Dica:</strong> Selecione a data no calend√°rio e clique em "Adicionar Data". Voc√™ pode adicionar v√°rias datas de vencimento.
                                </p>
                            </div>

                            <!-- Campo oculto para enviar as datas ao servidor -->
                            <input type="hidden" name="dias_pagamento" x-model="datasVencimento.join(', ')">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìé Documento do Boleto (opcional)</label>
                            <input type="file" name="documento_boleto" accept=".pdf,.doc,.docx,image/*" class="w-full border border-gray-300 rounded-lg px-4 py-2 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-orange-100 file:text-orange-700 hover:file:bg-orange-200">
                        </div>
                    </div>

                    <!-- Upload de Nota Fiscal -->
                    <div class="mb-3">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üìé Nota Fiscal (documento) - opcional</label>
                        <input type="file" name="documento_nota_fiscal" accept=".pdf,.doc,.docx,image/*" class="w-full border border-gray-300 rounded-lg px-4 py-2 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-semibold">Confirmar</button>
                        <button type="button" @click="showBuy = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Form de Rejei√ß√£o de Compra -->
            <div x-show="showRejectBuy" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <form method="post" action="{% url 'rejeitar_compra' req.id %}">
                    {% csrf_token %}
                    <h4 class="font-semibold text-red-700 mb-3">‚ùå Rejeitar Compra</h4>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Motivo da Rejei√ß√£o *</label>
                    <textarea name="observacao" rows="2" required class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3" placeholder="Explique o motivo da rejei√ß√£o da compra..."></textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-semibold">Confirmar</button>
                        <button type="button" @click="showRejectBuy = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    </div>
                </form>
            </div>

            <!-- Form de Recebimento -->
            <div x-show="showReceive" x-transition class="mt-4 pt-4 border-t border-gray-200">
                <form method="post" action="{% url 'marcar_como_recebido' req.id %}">
                    {% csrf_token %}
                    <h4 class="font-semibold text-green-700 mb-3">üì¶ Confirmar Recebimento</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nota Fiscal</label>
                            <input type="text" name="nota_fiscal" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Data de Entrega Prevista</label>
                            <input type="date" name="data_entrega_prevista" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Observa√ß√£o (opcional)</label>
                        <textarea name="observacao" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-2" placeholder="Observa√ß√µes sobre o recebimento..."></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-semibold">Confirmar</button>
                        <button type="button" @click="showReceive = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
        {% empty %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <p class="text-gray-500 font-semibold">Nenhuma requisi√ß√£o encontrada</p>
            <p class="text-gray-400 text-sm mt-1">
                {% if status_filtro != 'todas' %}
                    Tente mudar o filtro ou <a href="?status=todas" class="text-indigo-600 hover:underline">ver todas</a>
                {% else %}
                    Crie sua primeira requisi√ß√£o clicando no bot√£o acima
                {% endif %}
            </p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Nova Compra -->
<div id="modal-nova-requisicao" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target === this) this.style.display='none'">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Nova Compra</h2>
            <button onclick="document.getElementById('modal-nova-requisicao').style.display='none'" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form method="post" action="{% url 'criar_requisicao' %}">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Item *</label>
                    <input type="text" name="item" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Parafuso M6">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Descri√ß√£o *</label>
                    <textarea name="descricao" rows="3" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Descreva o item em detalhes..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Quantidade *</label>
                        <input type="number" step="0.01" name="quantidade" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Unidade</label>
                        <select name="unidade" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="un">un</option>
                            <option value="kg">kg</option>
                            <option value="m">m</option>
                            <option value="l">l</option>
                            <option value="cx">cx</option>
                            <option value="rolo">rolo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Pre√ßo Est. (R$) *</label>
                        <input type="number" step="0.01" name="preco_estimado" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Prop√≥sito *</label>
                    <input type="text" name="proposito" required class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Manuten√ß√£o, Produ√ß√£o, Estoque">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Projeto (opcional)</label>
                    <input type="text" name="projeto" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Projeto X, Cliente Y">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Link do Item (opcional)</label>
                    <input type="url" name="link_item" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="https://exemplo.com/produto">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                    Criar Compra
                </button>
                <button type="button" onclick="document.getElementById('modal-nova-requisicao').style.display='none'" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
